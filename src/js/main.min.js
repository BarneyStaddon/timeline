/*!
 * Demo collection timeline
 * Author: Barney Staddon 2015
 * Uses iscroll - https://github.com/cubiq/iscroll
 */
var MOLTime=MOLTime||{}
MOLTime.props={scroll:null,startYear:1900,endYear:2e3,duration:null,yearWidth:100,footerHeight:48,objectMarkerWidth:80,apiURL:"http://localhost/skeleton/api/objects/search/",imageURL:"http://fe02.museumoflondon.org.uk/imagestore",itemIds:["69.142","34.170/975","90.192a","59.74/7","88.18","2003.98","NN11664","PLA646","81.208/5","45.15","2000.255","IN24510","2007.1/172","2003.2/282","84.16/16","93.104/11","2003.5/61","2008.43/40","2000.36","2007.1/153","2000.230/3"],iscrollOptions:{scrollX:!0,scrollY:!1,mouseWheel:!0,tap:!0,bounce:!1,probeType:3},objectsData:[],markerOpen:!1,transitionSpeed:400,currentObject:null,markerOffset:0,scrollEndHandlerArgs:null,movedWrapper:!1,objectMap:null,objectPanel:null},MOLTime.buildTimelineDOM=function(e,r){MOLTime.props.duration=MOLTime.props.endYear-MOLTime.props.startYear
for(var t=0,s=MOLTime.props.duration;s>t;t++){var i=document.createElement("li"),a=document.createElement("div"),o=document.createElement("div"),n="year-"+Number(MOLTime.props.startYear+t),p=t%2==0?"dateline-even":"dateline-odd",l=MOLTime.checkForYearObject(MOLTime.props.startYear+t,e)
if($(i).attr("id",n),$(o).addClass("year-container"),$(a).addClass("dateline"),$(a).addClass(p),$(a).html(MOLTime.props.startYear+t),l){var m=MOLTime.buildObjectMarker(MOLTime.props.startYear+t,l)
$(o).append(m[0]),$(o).append(m[1])}$(o).append(a),$(i).append(o),$("#tl-years").append(i)}$("#scroller").css("width",MOLTime.props.yearWidth*MOLTime.props.duration+"px"),$("#scroller li").css("width",MOLTime.props.yearWidth+"px"),document.addEventListener("touchmove",function(e){(MOLTime.props.markerOpen=!1)&&e.preventDefault()},!1),MOLTime.props.scroll=new IScroll("#wrapper",MOLTime.props.iscrollOptions),MOLTime.props.scroll.on("scroll",function(e){r.moveScrubber()})},MOLTime.buildObjectMarker=function(e,r){var t,s=Math.floor(MOLTime.props.yearWidth/100*MOLTime.props.objectMarkerWidth),i=Math.round(Math.random()),a=Math.floor(window.innerHeight/2-15)
t=i?25+Math.floor(Math.random()*(a-2.5*s)):Math.floor(window.innerHeight/2+Math.floor(Math.random()*(a-2*s)))
var o=i?t:a,n=i?a-t:t-a,p=document.createElement("div"),l=document.createElement("div")
return $(p).addClass("stick"),$(p).attr("id","stick-"+e),$(p).attr("data-height",n),$(p).css("top",o+"px"),$(p).css("height",n+"px"),$(l).addClass("object-marker"),$(l).attr("id","object-marker-"+e),$(l).attr("data-height",t),$(l).css("top",t+"px"),$(l).css("height",s+"px"),$(l).css("background-image","url("+MOLTime.props.imageURL+r.originalMediaLocation[0]+")"),$(l).on("tap",MOLTime.markerHandler),[p,l]},MOLTime.markerHandler=function(e){if(!MOLTime.props.markerOpen){var r=e.target.id.substr(e.target.id.length-2),t=e.target.style.top.substr(0,e.target.style.top.length-2)
totalWidth=MOLTime.props.duration*MOLTime.props.yearWidth,currentOffset=MOLTime.props.scroll.x,targetXPos=r*MOLTime.props.yearWidth,centreX=Math.floor(window.innerWidth/2)-MOLTime.props.yearWidth/2,targetOffset=0-(targetXPos-centreX),offsetDist=targetOffset-currentOffset,$("#object-marker-19"+r).addClass("object-marker-grow"),currentOffset+offsetDist<=0&&currentOffset+offsetDist>=0-(totalWidth-window.innerWidth)?(MOLTime.props.markerOffset=offsetDist,MOLTime.props.scroll.scrollBy(offsetDist,0,MOLTime.props.transitionSpeed),$("#year-19"+r+" .dateline").css("color","#FFCC00"),MOLTime.props.scrollEndHandlerArgs={date:r,top:t},MOLTime.props.scroll.on("scrollEnd",MOLTime.scrollEndHandler)):(MOLTime.props.movedWrapper=!0,$("#wrapper").one(MOLTime.utils.whichTransitionEvent(),function(e){MOLTime.animateObjectMarker(r,t)}),$("#year-19"+r+" .dateline").css("color","#FFCC00"),$("#wrapper").css({"-webkit-transform":"translateX("+offsetDist+"px)"}),$("#wrapper").css({"-ms-transform":"translateX("+offsetDist+"px)"}),$("#wrapper").css({transform:"translateX("+offsetDist+"px)"}))}},MOLTime.scrollEndHandler=function(){MOLTime.props.scroll.off("scrollEnd",MOLTime.scrollEndHandler),MOLTime.animateObjectMarker(MOLTime.props.scrollEndHandlerArgs.date,MOLTime.props.scrollEndHandlerArgs.top)},MOLTime.animateObjectMarker=function(e,r){MOLTime.disableTimeline(!0)
var t,s,i=Math.floor(MOLTime.props.yearWidth/100*MOLTime.props.objectMarkerWidth),a=(Math.floor(1.5*i),30)
$("#stick-19"+e).one(MOLTime.utils.whichTransitionEvent(),function(r){MOLTime.initObjectPanel(e)}),r<window.innerHeight/2?(s=0+a,t=0-(r-s),$("#stick-19"+e).addClass("stick-grow"),$("#stick-19"+e).css("height",window.innerHeight/2-(s+30)+"px"),$("#stick-19"+e).css({"-webkit-transform":"translateY("+t+"px)"}),$("#stick-19"+e).css({"-ms-transform":"translateY("+t+"px)"}),$("#stick-19"+e).css({transform:"translateY("+t+"px)"})):($("#stick-19"+e).addClass("stick-grow"),$("#stick-19"+e).css("height",Math.floor(window.innerHeight/2-(i+MOLTime.props.footerHeight))+"px"),s=window.innerHeight-(i+a+MOLTime.props.footerHeight),t=s-r),$("#object-marker-19"+e).css({"-webkit-transform":"translateY("+t+"px) scale(1.5)"}),$("#object-marker-19"+e).css({"-ms-transform":"translateY("+t+"px scale(1.5)"}),$("#object-marker-19"+e).css({transform:"translateY("+t+"px) scale(1.5)"})},MOLTime.initObjectPanel=function(e){MOLTime.props.objectPanel=new ObjectView(MOLTime.props,MOLTime.utils,$("#object-data-container")),MOLTime.props.objectPanel.init(e)},MOLTime.checkObjectImageFit=function(){var e=$(".image-container").width()
$("#object-image").css("width",e+"px")},MOLTime.initializeMap=function(){MOLTime.props.objectMap=new google.maps.Map(document.getElementById("map-canvas"),{zoom:10,center:{lat:51.5073,lng:.12755}})},MOLTime.scrollEndReverseHandler=function(){MOLTime.props.scroll.off("scrollEnd",MOLTime.scrollEndReverseHandler),MOLTime.reverseMarkerAnimation(MOLTime.props.scrollEndHandlerArgs.date)},MOLTime.reversePositionAnimation=function(e){var r=MOLTime.props.markerOffset<0?-1*MOLTime.props.markerOffset:0-MOLTime.props.markerOffset
MOLTime.props.movedWrapper?($("#wrapper").one(MOLTime.utils.whichTransitionEvent(),function(r){MOLTime.reverseMarkerAnimation(e),MOLTime.props.movedWrapper=!1}),$("#wrapper").css({"-webkit-transform":"translateX(0px)"}),$("#wrapper").css({"-ms-transform":"translateX(0px)"}),$("#wrapper").css({transform:"translateX(0px)"})):(MOLTime.props.scroll.on("scrollEnd",MOLTime.scrollEndReverseHandler),MOLTime.props.scroll.scrollBy(r,0,MOLTime.props.transitionSpeed))},MOLTime.reverseMarkerAnimation=function(e){$("#year-19"+e+" .dateline").css("color","#FFF"),$("#stick-19"+e).one(MOLTime.utils.whichTransitionEvent(),function(e){MOLTime.props.markerOffset=0,MOLTime.enableTimeline(!0)}),$("#stick-19"+e).css("height",$("#stick-19"+e)[0].dataset.height+"px"),$("#stick-19"+e).css({"-webkit-transform":"translateY(0px)"}),$("#stick-19"+e).css({"-webkit-transform":"translateY(0px)"}),$("#stick-19"+e).css({"-ms-transform":"translateY(0px)"}),$("#stick-19"+e).css({transform:"translateY(0px)"}),$("#object-marker-19"+e).css({"-webkit-transform":"translateY(0px) scale(1)"}),$("#object-marker-19"+e).css({"-ms-transform":"translateY(0px) scale(1)"}),$("#object-marker-19"+e).css({transform:"translateY(0px) scale(1)"})},MOLTime.disableTimeline=function(e){e&&(MOLTime.props.markerOpen=!0),MOLTime.props.scroll.disable()},MOLTime.enableTimeline=function(e){e&&(MOLTime.props.markerOpen=!1),MOLTime.props.scroll.enable()},MOLTime.fetchObjectsData=function(e){for(var r=0,t=e.length;t>r;r++)!function(r){var t=MOLTime.props.itemIds[r].replace("/","-")
$.get(MOLTime.props.apiURL+t,function(r,t){var s=JSON.parse(r)
MOLTime.props.objectsData.push(s.response.docs[0]),MOLTime.props.objectsData.length==e.length&&MOLTime.buildTimelineDOM(MOLTime.props.objectsData,new Scrubber(MOLTime.props))})}(r)},MOLTime.checkForYearObject=function(e,r){for(var t=0,s=r.length;s>t;t++)if(r[t].dateMadeLatest[0]==e)return r[t]
return!1},MOLTime.addResizingHandler=function(){$(window).resize(function(){MOLTime.props.objectsData.length>0&&(null!=MOLTime.props.scroll&&($("#tl-years").empty(),MOLTime.props.scroll.destroy(),MOLTime.buildTimelineDOM(MOLTime.props.objectsData,new Scrubber(MOLTime.props))),MOLTime.props.markerOpen&&MOLTime.checkObjectImageFit())})},MOLTime.init=function(){MOLTime.addResizingHandler(),MOLTime.fetchObjectsData(MOLTime.props.itemIds)}
